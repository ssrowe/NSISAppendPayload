# Append Payload to Signed NSIS Executable Installer File

This program allows you to embed a payload containing custom user data into an executable generated by [NSIS (Nullsoft Scripted Installer System)](http://nsis.sourceforge.net/) and signed with Microsoft SignTool.exe (or similar). This is tested and working with the [NSIS ReadCustomerData Function](http://nsis.sourceforge.net/ReadCustomerData). Windows recognizes the original digital signature since we are just adding arbitrary data and did not modify the code.

This allows you to create a master installer that is signed and runs properly on Windows, and then add custom data in at a later time.  This data can be anything, but a common usecase is to add user-specific data such as a fingerprint or key upon download so that the user does not have to enter the data during setup.  The alternative is to create and then sign a custom installer for each user which is much more error prone and prolongs the download process.

| :zap:        WARNING: The technique used to add payload to a signed exe takes advantage of CVE-2013-3900. If the "EnableCertPaddingCheck" registry key is configured as described in Microsoft Security Advisory 2915720, the signature verification will fail after adding your payload to the signed exe. Microsoft currently disables the "EnableCertPaddingCheck" setting by default, but this may change in the future. Thank you to [@MustrumRidcully0](https://github.com/MustrumRidcully0) for identifying this issue.   |
|-----------------------------------------|

## Getting Started

Install NSIS from https://nsis.sourceforge.io/Download

Create Self-Signed TEST Certificate using PowerShell for testing/development purposes.  Obviously, this should not be used for produciton or distribution.
```
$cert = New-SelfSignedCertificate -DnsName TESTGestalt -FriendlyName "TEST - Gestalt Diagnostics" -Type CodeSigning -CertStoreLocation Cert:\CurrentUser\My -HashAlgorithm "SHA256" -NotAfter (Get-Date).AddYears(10)
$CertPassword = ConvertTo-SecureString -String "password123" -Force –AsPlainText
Export-PfxCertificate -Cert "Cert:\CurrentUser\My\$($cert.Thumbprint)" -FilePath "c:\temp\TestCert.pfx" -Password $CertPassword
```

Make the cert trusted by opening certmgr.msc and dragging the cert from 'Personal/Certificates' to 'Trusted Root Certifciation Authorities/Certificates'.  Consult your organization security policies and procedures.  This impacts the security of the machine.

Compile TestInstall.nsi into TestInstall.exe using NSIS and sign TestInstall.exe using signtool.exe or similar.  NSIS can also be ran from Linux to build Windows setups.
```
example>"C:\Program Files (x86)\NSIS\makensis.exe" TestInstall.nsi
signtool.exe sign /f TestCert.pfx /p password123 TestInstall.exe
```

Go ahead and run the exe.  You should see that is it properly signed and get a 'Hello World!' popup as well as one stating 'No data found'.

Move over to a Linux shell e.g. WSL

### Building NSISAppendPayload for Linux/Mac
```
> # Install g++ on Debian
> apt-get install g++
> # Compile
> g++ -o NSISAppendPayload  NSISAppendPayload.cpp
```

### Building NSISAppendPayload for Windows
* Install https://visualstudio.microsoft.com/downloads/#build-tools-for-visual-studio-2019
* Check out [this article](https://docs.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-160) and [this one](https://docs.microsoft.com/en-us/cpp/build/walkthrough-compiling-a-native-cpp-program-on-the-command-line?view=msvc-160) for details on using the VS C++ from the commandline.
* Open 'x64 Native Tools Command Prompt for VS 2019' from the start menu
```
> cd \NSISAppendPayload\src\windows
> cl /EHsc NSISAppendPayload.cpp
```

### Add Custom Data to Signed Setup
```
> # Option 1: Add custom data into signed setup
> ./NSISAppendPayload TestInstall.exe CUSTDATA:value1;value2 CustomTestInstall.exe
```

```
> # Option 2: Add custom data from file into signed setup
> ./NSISAppendPayload TestInstall.exe file://TestInstall.dat CustomTestInstall.exe
```

Now run CustomTestInstall.exe on Windows and you should see a popup box with the data you added from the setup.

## Technical Details

Original Source: [Changing a Signed Executable Without Altering Windows Digital Signature](https://blog.barthe.ph/2009/02/22/change-signed-executable/) by Aymeric Barthe 02/22/2019

The way Microsoft authenticode works is the following. During the signature process, it computes the hash on the executable file. The hash is then used to make a digital certificate which is authenticated by some authority. This certificate is attached to the end of the PE exectuable, in a dedicated section called the Certificate Table. When the executable is loaded, Windows computes the hash value, and compares it to the one attached to the Certificate table. It is “normally” impossible to change anything in the file without breaking the digital authentication.

However three areas of a PE executable are excluded from the hash computation:

* the Checksum in the optional Windows specific header. 4 bytes.
* the Certificate Table entry in the optional Windows specific header. 8 bytes.
* the Digital Certificate section at the end of the file. Variable length.

You should be able to change those area without breaking the signature. I have discovered by accident that it is possible to append an arbitrary ammount of data at the end of the Digital Certificate. These data are ignored by both the signature parsing and hash computation algorithms. It works on all version of Windows I tested (2000, XP, Vista) as long as the length of the Certificate Table is correctly increased. The length is stored in two different location: the PE header and the beginning of the certificate table.

How to add a payload

1. Locate beginning of PE header (PE)
1. Skip COFF header (+=28 bytes)
1. Go to Certification Table Entry in the Windows specific optional PE header (+=120 bytes after COFF; total +=148 bytes)
1. Change size of Certificate Table as defined in IMAGE_DATA_DIRECTORY.Size to add the size of the payload.
1. Go to location defined IMAGE_DATA_DIRECTORY.VirtualAddress. This is the absolute location of the Certificate Table within the file.
1. Change again the size of the header, inside the PKCS1_MODULE_SIGN.dwLength
1. This should normally be the last section in the executable; so go to the end and add payload
1. Possibly calculate the new checksum of the file
1. Caution: the previous constants are true for the 32bit x86 versions of Windows. Payload needs to be 64bits aligned. All the 32 bits constants are of course little endians woo woo!


## Getting Started

This repository includes the [original code]() written for Windows by Aymeric Barthe as well as modified code tested on Linux and macOS.

You will need to download to Linux or macOS, install the g++ compiler, compile the program, and run. Details below.


### Prerequisites

Install g++ on Debian Linux 9 by running the following command:

```
apt-get install g++
```

I tested with the following g++ compiler on Debian 9:

```
$ g++ --version
g++ (Debian 6.3.0-18+deb9u1) 6.3.0 20170516
Copyright (C) 2016 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

Install g++ on macOS by installing XCode.

I tested with the following g++ compiler on macOS 10.13:

```
$ g++ --version
Configured with: --prefix=/Library/Developer/CommandLineTools/usr --with-gxx-include-dir=/usr/include/c++/4.2.1
Apple LLVM version 9.0.0 (clang-900.0.39.2)
Target: x86_64-apple-darwin17.4.0
Thread model: posix
InstalledDir: /Library/Developer/CommandLineTools/usr/bin
```


### Installing

Compile the program using the following command on Linux or macOS:

```
> g++ -o NSISAppendPayload  NSISAppendPayload.cpp
```

End with an example of getting some data out of the system or using it for a little demo


## Usage

The following commands will READ SetupMaster.exe (your signed NSIS installer), append payload from SetupUser123.dat, and write a custom NSIS installer file SetupUser123.exe with embedded username and password. The original digital signature will still be intact.

```
echo "CUSTDATA:username123;password123" > SetupUser123.dat
./AppendPayLoad SetupMaster.exe SetupUser123.dat SetupUser123.exe
```

Use the NSIS [ReadCustomerData](http://nsis.sourceforge.net/ReadCustomerData) function to read the appended data. Learn more in my [NSIS ReadCustomerData without invalidating SignTool Digital Signature blog post](https://jrklein.com/2018/03/25/nsis-readcustomerdata-without-invalidating-signtool-digital-signature/).

## References

* [Changing a Signed Executable Without Altering Windows Digital Signature](https://blog.barthe.ph/2009/02/22/change-signed-executable/) - Original release by Aymeric Barthe on 02/22/2009
* [Hackers Library - The PE Format](http://www.thehackerslibrary.com/?p=377) - Documentation by Gaurav Mogre 12/08/2008 (archived in this repo)
* [Microsoft KB 904424 - IMAGE_DATA_DIRECTORY](http://msdn.microsoft.com/en-us/library/ms904424.aspx) - This structure represents the data directory.
* [Microsoft KB 448396 - Signature Creation](http://msdn.microsoft.com/en-us/library/aa448396.aspx) - Signature format details

## Authors

* **Aymeric Barthe** - *Initial work* - [@aymericb](https://github.com/aymericb)
* **Jason Klein** - Adapt/test on Linux/macOS - [@jason-klein](https://github.com/jason-klein/)
